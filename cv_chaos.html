<!DOCTYPE HTML>
<html>
	<head>
		<title>Computer Vision & Chaos Theory</title>
		<meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<script async src="assets/js/opencv.js" onload="openCvReady();"></script>
		<script src="assets/js/utils.js"></script>
		<link rel="stylesheet" href="assets/css/main.css" />
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>
		<style>
			figure {
				display : inline-block;
				margin-top: 1em;
				margin-bottom: 1em;
				margin-left: 40px;
				margin-right: 40px;
			}
			</style>
	</head>
	<body class="is-preload">
		<div id="page-wrapper">

			<!-- Header -->
			<header id="header">
				<h1 id="logo"><a href="index.html"></a></h1>
				<nav id="nav">
					<ul>
						<li><a href="index.html"><b>MOD</b></a></li>
						<li>
							<a href="#"><b>Projects</b></a>
							<ul>
								<li><a href="cryptotrading.html">Cryptocurrency Trading</a></li>
								<li><a href="cv_chaos.html">Computer Vision & Chaos Theory</a></li>
							</ul>
						</li>
					</ul>
				</nav>
			</header>

			<!-- Main -->
				<div id="main" class="wrapper style1">
					<div class="container">
						<header class="major">
							<h2>Computer Vision & Chaos Theory</h2>
						</header>

						<!-- Content -->
						<section id="content">
							
							<h3>Input & Computer Vision</h3>
							<video id="cam_input" height="480" width="640"></video>
							<canvas id="canvas_output"></canvas>

							<script>
								let x_image = Math.round(2*(face.x + face.width/2)/video.width);
								document.write(x_image);
							</script>

							<h3>Output: Chaos</h3>
							<canvas id="canvas_chaos" width="600" height="400"></canvas>

							<h3>Breve Descrizione</h3>
							L'algoritmo identifica la vostra faccia, utilizza la sua posizone per variare in real-time il valore di due parametri associati al calcolo
							della mappa del <a href="https://shaddenlab.berkeley.edu/uploads/LCS-tutorial/FTLE-derivation.html">Finite-Time Lyapunov Exponent </a> nello spazio delle condizioni iniziali
							della <a href="https://en.wikipedia.org/wiki/Standard_map">mappa standard</a>, rilevante per la teoria del chaos e per 
							<a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=4041723">applicazioni in meccanica orbitale</a>. 
						</section>
					</div>
				</div>



			<!-- Footer -->
			<footer id="footer">
				<ul class="icons">
					<li><a href="https://www.instagram.com/mod.network/" class="icon brands alt fa-instagram"><span class="label">Instagram</span></a></li>
					<li><a href="https://github.com/orgs/MinistryOfDeployment" class="icon brands alt fa-github"><span class="label">GitHub</span></a></li>
					<li><a href="#" class="icon solid alt fa-envelope"><span class="label">Email</span></a></li>
				</ul>
			</footer>

		</div>

		<!-- Scripts -->
			<script src="assets/js/jquery.min.js"></script>
			<script src="assets/js/jquery.scrolly.min.js"></script>
			<script src="assets/js/jquery.dropotron.min.js"></script>
			<script src="assets/js/jquery.scrollex.min.js"></script>
			<script src="assets/js/browser.min.js"></script>
			<script src="assets/js/breakpoints.min.js"></script>
			<script src="assets/js/util.js"></script>
			<script src="assets/js/main.js"></script>

			<script type="text/JavaScript">
				function openCvReady() {
				  cv['onRuntimeInitialized']=()=>{
					let video = document.getElementById("cam_input"); // video is the id of video tag
					navigator.mediaDevices.getUserMedia({ video: true, audio: false })
					.then(function(stream) {
						video.srcObject = stream;
						video.play();
					})
					.catch(function(err) {
						console.log("An error occurred! " + err);
					});
					let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
					let dst = new cv.Mat(video.height, video.width, cv.CV_8UC1);
					let gray = new cv.Mat();
					let cap = new cv.VideoCapture(cam_input);
					let faces = new cv.RectVector();
					let classifier = new cv.CascadeClassifier();
					let utils = new Utils('errorMessage');
					let faceCascadeFile = 'haarcascade_frontalface_default.xml'; // path to xml
					utils.createFileFromUrl(faceCascadeFile, faceCascadeFile, () => {
					classifier.load(faceCascadeFile); // in the callback, load the cascade from file 
				});
					const FPS = 24;
					function processVideo() {
						let begin = Date.now();
						cap.read(src);
						src.copyTo(dst);
						cv.cvtColor(dst, gray, cv.COLOR_RGBA2GRAY, 0);
						try{
							classifier.detectMultiScale(gray, faces, 1.1, 3, 0);
							console.log(faces.size());
						}catch(err){
							console.log(err);
						}
						for (let i = 0; i < faces.size(); ++i) {
							let face = faces.get(i);
							let point1 = new cv.Point(face.x, face.y);
							let point2 = new cv.Point(face.x + face.width, face.y + face.height);
							cv.rectangle(dst, point1, point2, [255, 0, 0, 255]);
						}
						cv.imshow("canvas_output", dst);

						let canvas = document.getElementById("canvas_chaos");

						let ctx = canvas.getContext("2d");
						let img = new Image();   // Create new img element

						img.src = 'images/stdmap4cv/plot' + 1 + '_' + 1 + '.png'; // Set source path

						ctx.drawImage(img, 0, 0, img.width, img.height);

						// schedule next one.
						let delay = 1000/FPS - (Date.now() - begin);
						setTimeout(processVideo, delay);
				}
				// schedule first one.
				setTimeout(processVideo, 0);
				  };
				}
				</script>
	</body>
</html>